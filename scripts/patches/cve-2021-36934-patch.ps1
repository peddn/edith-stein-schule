# Autor:        Peter Schmid <schmidp@edith-stein-schule.net>
# erstellt am:  22.04.2021
# Beschreibung: Skript um Sicherheitsluecke CVE-2021-36934 zu patchen
# Repository:   https://github.com/peddn/edith-stein-schule.git

# https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-36934
# https://support.microsoft.com/de-de/topic/kb5005357-l%C3%B6schen-von-schattenkopien-im-volumen-1ceaa637-aaa3-4b58-a48b-baf72a2fa9e7

# Log Verzeichnis
$logDir = "$env:LOCALAPPDATA\ess_logs"

# Wenn das Verzeichnis nicht existiert
If (-Not (Test-Path -Path $logDir)) {
    # erstelle Verzeichnis
    New-Item -Path $logDir -ItemType "directory"
}


# Logdatei
$logfile = "$logDir\cve-2021-36934_patch.log"

# Kommando um Zugriffsrechte zu beschraenken
$restrict = "icacls $env:windir\system32\config\*.* /inheritance:e"

# Kommando zum Auflisten aller Schattenkopien
$listShadows = "vssadmin list shadows"

# Kommando zum Loeschen aller Schattenkopien
$deleteShadows = "vssadmin delete shadows /All /Quiet"


# BESCHRAENKT ZUGRIFFSRECHTE FUER \windows\system32\config

# fuehre Kommando aus
$restrictOut = Invoke-Expression $restrict

# schreibe die Ergebnisse in die Logdatei
"`n[restrict access to \windows\system32\config]`n" | out-file -filepath $logfile -append
$restrictOut | out-file -filepath $logfile -append


# LOESCHT ALLE SCHATTENKOPIEN

# liste alle Schattenkopien auf
$shadowsList = Invoke-Expression $listShadows

# schreibe die Liste in die Logdatei
"`n[shadow copies BEFORE delete command]`n" | out-file -filepath $logfile -append
$shadowsList | out-file -filepath $logfile -append

# loesche alle Schattenkopien
$shadowDelete = Invoke-Expression $deleteShadows

# schreibe das Ergebnis in die Logdatei
"`n[deleting shadow copies...]`n" | out-file -filepath $logfile -append
$shadowDelete | out-file -filepath $logfile -append

# liste alle Schattenkopien erneut auf
$shadowsList = Invoke-Expression $listShadows

# schreibe die Liste in die Logdatei
"`n[shadow copies AFTER delete command]`n" | out-file -filepath $logfile -append
$shadowsList | out-file -filepath $logfile -append
